<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è€ƒç ”ä¸ªäººç«™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --brand: #7c5cff;
      --brand2: #4fd1c5;
      --shadow: 0 18px 50px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 24px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Microsoft YaHei UI", "PingFang SC";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,0.35), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(79,209,197,0.18), transparent 55%),
        radial-gradient(900px 700px at 40% 95%, rgba(255,255,255,0.08), transparent 60%),
        var(--bg);
      overflow-x: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    nav{
      position: sticky;
      top:0;
      z-index: 20;
      padding: 12px 12px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      background: rgba(11,16,32,0.65);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      overflow-x: auto;
      scrollbar-width: none;
    }
    nav::-webkit-scrollbar{ display:none; }

    .tab{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
      font-size: 14px;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tab:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.07);
      color: var(--text);
      border-color: rgba(255,255,255,0.16);
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(124,92,255,0.35), rgba(79,209,197,0.20));
      color: var(--text);
      border-color: rgba(124,92,255,0.55);
    }

    /* åŒºå—å¸ƒå±€ */
    section{ display:none; padding: 22px 14px 44px; }
    section.active{ display:block; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }

    /* å¡ç‰‡å®¹å™¨ */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.075), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius2);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    h2{
      margin: 0 0 10px;
      font-size: clamp(18px, 2.3vw, 22px);
      letter-spacing: .2px;
    }
    h3{
      margin: 16px 0 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
    }
    p{ color: var(--muted); margin: 8px 0; }

    /* ç»Ÿä¸€è¡¨å•æ§ä»¶ */
    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

    input{
      flex: 0 0 auto;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, background .15s ease, transform .15s ease;
    }
    input::placeholder{ color: rgba(255,255,255,0.45); }
    input:focus{
      border-color: rgba(124,92,255,0.55);
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }

    button{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(124,92,255,0.35);
      background: linear-gradient(135deg, rgba(124,92,255,0.95), rgba(124,92,255,0.70));
      color: white;
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease;
      font-weight: 700;
      flex: 0 0 auto;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:active{ transform: translateY(0); }

    button.secondary{
      border-color: rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
    }

    hr{
      border: none;
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 16px 0;
    }

    /* ========== å€’è®¡æ—¶ï¼ˆé‡ç‚¹ç¾åŒ–ï¼‰ ========== */
    .hero{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100vh - 72px);
    }

    .hero-inner{
      width: 100%;
    }

    .hero-title{
      text-align:center;
      margin: 0 0 10px;
      font-size: clamp(20px, 3vw, 28px);
      font-weight: 900;
      letter-spacing: .6px;
      background: linear-gradient(90deg, rgba(124,92,255,1), rgba(79,209,197,1));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .hero-sub{
      text-align:center;
      color: var(--muted);
      margin: 0 0 16px;
      font-size: clamp(12px, 1.8vw, 14px);
    }

    .countdown{
      display:grid;
      grid-template-columns: repeat(4, minmax(70px, 120px));
      gap: clamp(10px, 2.2vw, 18px);
      justify-content: center; /* æ•´ä½“å±…ä¸­ */
      align-items: stretch;
      margin-top: 18px;
    }

    .time-box{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: clamp(12px, 2.4vw, 18px);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      text-align:center; /* å†…å®¹å±…ä¸­ */
    }

    .time-box::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(124,92,255,0.25), transparent 55%),
                  radial-gradient(circle at 80% 60%, rgba(79,209,197,0.16), transparent 55%);
      filter: blur(6px);
      opacity: .7;
      pointer-events:none;
    }

    .time-num{
      position: relative;
      display:block;
      font-size: clamp(32px, 5.5vw, 56px); /* æ•°å­—æ›´å¤§ */
      font-weight: 900;
      line-height: 1.1;
      letter-spacing: .6px;
      margin-top: 2px;
      text-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .time-lab{
      position: relative;
      display:block;
      margin-top: 10px;
      font-size: clamp(18px, 2.6vw, 24px); /* â€œå¤©/æ—¶/åˆ†/ç§’â€æ›´å¤§ */
      font-weight: 800;
      color: rgba(255,255,255,0.82);
      letter-spacing: 4px;
    }

    /* è·³åŠ¨æ•ˆæœ */
    .jump{
      transform: translateY(-6px);
      transition: transform .18s ease;
    }

    .hint{
      margin-top: 12px;
      text-align:center;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
    }

    /* ç•™è¨€åˆ—è¡¨ */
    #msgList .msg{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 8px 0;
    }
    #msgList .meta{
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      margin-bottom: 4px;
    }

    /* Chat bubbles */
    #chatBox{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px;
    }

    .chat-item{
      display: flex;
      margin: 10px 0;
    }
    .chat-item.user{ justify-content: flex-end; }
    .chat-item.assistant{ justify-content: flex-start; }

    .chat-bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      white-space: pre-wrap;
      line-height: 1.55;
    }
    .chat-item.user .chat-bubble{
      background: linear-gradient(135deg, rgba(124,92,255,0.75), rgba(124,92,255,0.45));
      border-color: rgba(124,92,255,0.45);
    }
    .typing{
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .typing span{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      animation: blink 1s infinite;
    }
    .typing span:nth-child(2){ animation-delay: .15s; }
    .typing span:nth-child(3){ animation-delay: .3s; }
    @keyframes blink{
      0%, 100%{ opacity: .25; transform: translateY(0); }
      50%{ opacity: 1; transform: translateY(-2px); }
    }

    /* TODO åˆ—è¡¨ */
    #todoList{
      padding-left: 0;
      margin: 14px 0 0;
    }
    #todoList li{
      margin: 10px 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      list-style: none;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #todoList input[type="checkbox"]{
      min-width: auto;
      width: 18px;
      height: 18px;
      accent-color: var(--brand);
    }

    /* æ‰‹æœºç«¯ï¼šå€’è®¡æ—¶ 2x2 */
    @media (max-width: 520px){
      .countdown{
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        max-width: 380px;
        margin-left:auto;
        margin-right:auto;
      }
      input{ min-width: 140px; }
      .card{ padding: 16px; }
      .hero{ min-height: calc(100vh - 66px); }
    }

    /* Light theme */
    body.light{
      --bg: #f6f7fb;
      --panel: rgba(0,0,0,0.04);
      --panel2: rgba(0,0,0,0.06);
      --border: rgba(0,0,0,0.10);
      --text: rgba(0,0,0,0.88);
      --muted: rgba(0,0,0,0.55);
      --shadow: 0 18px 45px rgba(0,0,0,0.12);
    }
    body.light{
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,0.18), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(79,209,197,0.10), transparent 55%),
        radial-gradient(900px 700px at 40% 95%, rgba(0,0,0,0.05), transparent 60%),
        var(--bg);
    }
    body.light .time-lab{ color: rgba(0,0,0,0.70); }
    body.light .hero-sub{ color: rgba(0,0,0,0.55); }

    /* å‡å°‘åŠ¨ç”»åå¥½ */
    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
      .jump{ transform: none !important; }
    }
  </style>
</head>

<body>

<nav>
  <button class="tab active" data-target="sec-home" type="button">å€’è®¡æ—¶</button>
  <button class="tab" data-target="sec-plan" type="button">å­¦ä¹ è§„åˆ’</button>
  <button class="tab" data-target="sec-board" type="button">ç•™è¨€æ¿</button>
  <button class="tab" data-target="sec-ai" type="button">AIåŠ©æ‰‹</button>
  <button class="tab" id="btnTheme" type="button">ğŸŒ™ å¤œé—´</button>
</nav>

<!-- å€’è®¡æ—¶ -->
<section id="sec-home" class="active">
  <div class="wrap hero">
    <div class="hero-inner">
      <div class="card">
        <h2 class="hero-title">è·ç¦» 2026 è€ƒç ” è¿˜å‰©</h2>
        <p class="hero-sub">ç›®æ ‡æ—¶é—´ï¼š2026-12-19 00:00:00ï¼ˆUTCï¼‰</p>

        <div class="countdown" aria-label="countdown">
          <div class="time-box">
            <span class="time-num" id="cd-days">0</span>
            <label class="time-lab">å¤©</label>
          </div>
          <div class="time-box">
            <span class="time-num" id="cd-hours">0</span>
            <label class="time-lab">æ—¶</label>
          </div>
          <div class="time-box">
            <span class="time-num" id="cd-minutes">0</span>
            <label class="time-lab">åˆ†</label>
          </div>
          <div class="time-box">
            <span class="time-num" id="cd-seconds">0</span>
            <label class="time-lab">ç§’</label>
          </div>
        </div>

        <div class="hint" id="cdHint">æ­£åœ¨åŒæ­¥æœåŠ¡å™¨æ—¶é—´â€¦</div>
      </div>
    </div>
  </div>
</section>

<!-- å­¦ä¹ è§„åˆ’ -->
<section id="sec-plan">
  <div class="wrap">
    <div class="card">
      <h2>å­¦ä¹ è§„åˆ’ï¼ˆTODOï¼‰</h2>

      <div class="row">
        <input id="todoInput" placeholder="ä»Šå¤©è¦åšä»€ä¹ˆï¼Ÿ" style="flex:1;">
        <button id="btnAddTodo" type="button">æ·»åŠ </button>
      </div>

      <ul id="todoList"></ul>
    </div>
  </div>
</section>

<!-- ç•™è¨€æ¿ -->
<section id="sec-board">
  <div class="wrap">
    <div class="card">
      <h2>ç•™è¨€æ¿</h2>

      <p><b>ç™»å½•çŠ¶æ€ï¼š</b><span id="authStatus">æœªç™»å½•</span></p>

      <div class="row">
        <input id="username" placeholder="ç”¨æˆ·å">
        <input id="password" type="password" placeholder="å¯†ç ">
        <button id="btnRegister" type="button">æ³¨å†Œ</button>
        <button id="btnLogin" type="button">ç™»å½•</button>
        <button class="secondary" id="btnLogout" type="button">é€€å‡º</button>
      </div>

      <hr>

      <div class="row">
        <input id="msgContent" placeholder="æƒ³å¯¹æˆ‘è¯´çš„è¯â€¦" style="flex:1;">
        <button id="btnPostMsg" type="button">å‘é€</button>
      </div>

      <div id="boardHint" style="margin-top:8px;color:rgba(255,255,255,0.65);"></div>

      <h3>æœ€æ–°ç•™è¨€</h3>
      <div id="msgList"></div>
    </div>
  </div>
</section>

<!-- AI -->
<section id="sec-ai">
  <div class="wrap">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">AI è€ƒç ”åŠ©æ‰‹</h2>
        <button class="secondary" id="btnClearChat" type="button">æ¸…ç©ºå¯¹è¯</button>
      </div>

      <div id="chatBox" style="height:360px; overflow:auto; margin-top:12px;"></div>

      <div class="row" style="margin-top:10px;">
        <input id="chatInput" placeholder="è¾“å…¥é—®é¢˜ï¼Œå›è½¦å‘é€â€¦" style="flex:1;">
        <button id="btnSendChat" type="button">å‘é€</button>
      </div>

      <div id="chatHint" style="margin-top:6px;color:rgba(255,255,255,0.65);"></div>
    </div>
  </div>
</section>

<script>
/* ---------------- åŸºç¡€é…ç½® ---------------- */
const API_BASE = "https://kaoyan-site.onrender.com";

/* ---------------- å°å·¥å…·ï¼šå®‰å…¨ä¸è¯·æ±‚ ---------------- */
function qs(v){ return encodeURIComponent(v ?? ""); }

async function apiFetch(path, options = {}, timeoutMs = 15000){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);

  try{
    const r = await fetch(API_BASE + path, {
      ...options,
      signal: controller.signal,
    });
    return r;
  } finally {
    clearTimeout(t);
  }
}

function setToken(t){ localStorage.setItem("token", t); }
function getToken(){ return localStorage.getItem("token"); }
function clearToken(){ localStorage.removeItem("token"); }

/* ---------------- Tab åˆ‡æ¢ ---------------- */
document.querySelectorAll(".tab").forEach(btn => {
  const target = btn.dataset.target;
  if(!target) return;
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(target).classList.add("active");
  });
});

/* ---------------- ä¸»é¢˜åˆ‡æ¢ ---------------- */
function applyTheme(theme) {
  if (theme === "light") {
    document.body.classList.add("light");
    document.getElementById("btnTheme").textContent = "â˜€ï¸ æ—¥é—´";
  } else {
    document.body.classList.remove("light");
    document.getElementById("btnTheme").textContent = "ğŸŒ™ å¤œé—´";
  }
  localStorage.setItem("theme", theme);
}
applyTheme(localStorage.getItem("theme") || "dark");
document.getElementById("btnTheme").addEventListener("click", () => {
  const cur = localStorage.getItem("theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
});

/* ---------------- å€’è®¡æ—¶ ---------------- */
function jumpIfChanged(id, val){
  const el = document.getElementById(id);
  const s = String(val);
  if(el.textContent !== s){
    el.textContent = s;
    el.classList.add("jump");
    setTimeout(()=>el.classList.remove("jump"),180);
  }
}

async function updateCountdown(){
  try{
    const r = await apiFetch("/countdown", { method: "GET" }, 8000);
    if(!r.ok){
      document.getElementById("cdHint").textContent = `å€’è®¡æ—¶è¯·æ±‚å¤±è´¥ï¼šHTTP ${r.status}`;
      return;
    }
    const d = await r.json();
    if(d.expired){
      document.getElementById("cdHint").textContent = "å·²åˆ°è¾¾ç›®æ ‡æ—¶é—´ï¼Œå†²ï¼";
      jumpIfChanged("cd-days", 0);
      jumpIfChanged("cd-hours", 0);
      jumpIfChanged("cd-minutes", 0);
      jumpIfChanged("cd-seconds", 0);
      return;
    }
    jumpIfChanged("cd-days", d.days);
    jumpIfChanged("cd-hours", d.hours);
    jumpIfChanged("cd-minutes", d.minutes);
    jumpIfChanged("cd-seconds", d.seconds);
    document.getElementById("cdHint").textContent = "æ¯ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¥è‡ªåç«¯ï¼‰";
  }catch(e){
    document.getElementById("cdHint").textContent = "ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åç«¯ï¼ˆRenderï¼‰";
  }
}
updateCountdown();
setInterval(updateCountdown, 1000);

/* ---------------- ç™»å½•çŠ¶æ€ UI ---------------- */
const authStatus = document.getElementById("authStatus");
function updateAuthUI() {
  authStatus.textContent = getToken() ? "å·²ç™»å½•" : "æœªç™»å½•";
}
updateAuthUI();

/* ---------------- ç•™è¨€æ¿ ---------------- */
const usernameEl = document.getElementById("username");
const passwordEl = document.getElementById("password");
const msgContentEl = document.getElementById("msgContent");
const boardHintEl = document.getElementById("boardHint");
const msgListEl = document.getElementById("msgList");

async function register() {
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  if(!u || !p) return boardHintEl.textContent = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º";

  const r = await apiFetch(`/auth/register?username=${qs(u)}&password=${qs(p)}`, { method:"POST" });
  boardHintEl.textContent = r.ok ? "æ³¨å†ŒæˆåŠŸ âœ…" : `æ³¨å†Œå¤±è´¥ï¼šHTTP ${r.status}`;
}

async function login() {
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  if(!u || !p) return boardHintEl.textContent = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º";

  const r = await apiFetch(`/auth/login?username=${qs(u)}&password=${qs(p)}`, { method:"POST" });
  const d = await r.json().catch(()=> ({}));
  if (r.ok && d.access_token) {
    setToken(d.access_token);
    updateAuthUI();
    boardHintEl.textContent = "ç™»å½•æˆåŠŸ âœ…";
  } else {
    boardHintEl.textContent = `ç™»å½•å¤±è´¥ï¼š${d.detail || ("HTTP " + r.status)}`;
  }
}

function logout() {
  clearToken();
  updateAuthUI();
  boardHintEl.textContent = "å·²é€€å‡º";
}

async function postMessage() {
  const t = getToken();
  if (!t) return boardHintEl.textContent = "è¯·å…ˆç™»å½•";
  const content = msgContentEl.value.trim();
  if(!content) return boardHintEl.textContent = "ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©º";

  const r = await apiFetch(`/messages?content=${qs(content)}`, {
    method:"POST",
    headers:{ Authorization:`Bearer ${t}` }
  });

  if (r.ok) {
    msgContentEl.value = "";
    boardHintEl.textContent = "å‘é€æˆåŠŸ âœ…";
    loadMessages();
  } else {
    const d = await r.json().catch(()=> ({}));
    boardHintEl.textContent = `å‘é€å¤±è´¥ï¼š${d.detail || ("HTTP " + r.status)}`;
  }
}

async function loadMessages() {
  const r = await apiFetch("/messages", { method:"GET" });
  if(!r.ok){
    msgListEl.innerHTML = "";
    boardHintEl.textContent = `åŠ è½½ç•™è¨€å¤±è´¥ï¼šHTTP ${r.status}`;
    return;
  }
  const d = await r.json().catch(()=>({items:[]}));
  msgListEl.innerHTML = "";
  (d.items || []).forEach(m => {
    const div = document.createElement("div");
    div.className = "msg";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = m.username ? `@${m.username}` : "@unknown";

    const content = document.createElement("div");
    content.textContent = m.content ?? "";

    div.appendChild(meta);
    div.appendChild(content);
    msgListEl.appendChild(div);
  });
}
loadMessages();

document.getElementById("btnRegister").addEventListener("click", register);
document.getElementById("btnLogin").addEventListener("click", login);
document.getElementById("btnLogout").addEventListener("click", logout);
document.getElementById("btnPostMsg").addEventListener("click", postMessage);

/* ---------------- AIï¼šä¼˜å…ˆ streamï¼Œå¤±è´¥è‡ªåŠ¨é™çº§ ---------------- */
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatHint = document.getElementById("chatHint");

let chatHistory = JSON.parse(localStorage.getItem("chatHistory")||"[]");
function saveChat(){ localStorage.setItem("chatHistory", JSON.stringify(chatHistory)); }

function renderChat(){
  chatBox.innerHTML = "";
  for(const m of chatHistory){
    const item = document.createElement("div");
    item.className = "chat-item " + (m.role === "user" ? "user" : "assistant");

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";
    bubble.textContent = m.content;

    item.appendChild(bubble);
    chatBox.appendChild(item);
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}
renderChat();

function addTyping(){
  const typingItem = document.createElement("div");
  typingItem.className = "chat-item assistant";
  typingItem.innerHTML = `
    <div class="chat-bubble">
      <span class="typing"><span></span><span></span><span></span></span>
    </div>`;
  chatBox.appendChild(typingItem);
  chatBox.scrollTop = chatBox.scrollHeight;
  return typingItem;
}

/* è§£æ SSEï¼šè¯»å– data: è¡Œ */
async function postStreamSSE(path, payload, onDelta){
  const t = getToken();
  const r = await apiFetch(path, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${t}`,
    },
    body: JSON.stringify(payload)
  }, 60000);

  if(!r.ok){
    const d = await r.json().catch(()=> ({}));
    return { ok:false, status:r.status, detail: d.detail || null };
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buf = "";

  while(true){
    const { value, done } = await reader.read();
    if(done) break;
    buf += decoder.decode(value, { stream:true });

    // æŒ‰ SSE äº‹ä»¶åˆ†å‰²ï¼ˆç©ºè¡Œï¼‰
    const parts = buf.split("\n\n");
    buf = parts.pop() || "";

    for(const part of parts){
      // æ‰¾ data: è¡Œ
      const lines = part.split("\n");
      for(const line of lines){
        const s = line.trim();
        if(s.startsWith("data:")){
          const data = s.slice(5).trim();
          if(!data) continue;
          if(data === "[DONE]") return { ok:true };
          onDelta(data);
        }
      }
    }
  }
  return { ok:true };
}

async function callAi(history){
  // åªä¿ç•™æœ€è¿‘ N è½®
  const last = history.slice(-10);

  // 1) ä¼˜å…ˆ /ai/streamï¼ˆæµå¼ï¼‰
  {
    let acc = "";
    const ok = await postStreamSSE("/ai/stream", { history: last }, (delta) => {
      acc += delta;
      // å®æ—¶æ›´æ–°æœ€åä¸€æ¡ assistant
      const lastMsg = chatHistory[chatHistory.length - 1];
      if(lastMsg && lastMsg.role === "assistant"){
        lastMsg.content = acc;
      }else{
        chatHistory.push({ role:"assistant", content: acc });
      }
      renderChat();
    });

    if(ok.ok) return { ok:true };
    // å¦‚æœä¸æ˜¯ 404/405ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼ˆè¯´æ˜åç«¯æŠ¥é”™äº†ï¼‰
    if(ok.status !== 404 && ok.status !== 405) return ok;
  }

  // 2) é™çº§ /ai/chat2ï¼ˆä½ ä¹‹å‰å†™çš„æ˜¯ query ä¼  historyï¼‰
  {
    const t = getToken();
    const url = `/ai/chat2?history=${qs(JSON.stringify(last))}`;
    const r = await apiFetch(url, { method:"POST", headers:{ Authorization:`Bearer ${t}` } }, 60000);
    const d = await r.json().catch(()=> ({}));
    if(r.ok) return { ok:true, reply: d.reply || "" };
    if(r.status !== 404 && r.status !== 405) return { ok:false, status:r.status, detail:d.detail || null };
  }

  // 3) æœ€åé™çº§ /ai/chatï¼ˆæœ€ç®€å•çš„å•è½® messageï¼‰
  {
    const t = getToken();
    const message = last.filter(x=>x.role==="user").slice(-1)[0]?.content || "";
    const r = await apiFetch(`/ai/chat?message=${qs(message)}`, { method:"POST", headers:{ Authorization:`Bearer ${t}` } }, 60000);
    const d = await r.json().catch(()=> ({}));
    if(r.ok) return { ok:true, reply: d.reply || "" };
    return { ok:false, status:r.status, detail:d.detail || null };
  }
}

async function sendChat(){
  if (!getToken()) return chatHint.textContent = "è¯·å…ˆç™»å½•ï¼ˆAI éœ€è¦é‰´æƒï¼‰";
  const msg = chatInput.value.trim();
  if (!msg) return;

  chatHint.textContent = "";
  chatInput.value = "";

  chatHistory.push({ role: "user", content: msg });
  saveChat();
  renderChat();

  // å…ˆæ”¾ä¸€ä¸ªç©º assistantï¼ˆç”¨äºæµå¼æ›´æ–°ï¼‰
  chatHistory.push({ role: "assistant", content: "" });
  saveChat();
  renderChat();

  const typingItem = addTyping();

  try{
    const res = await callAi(chatHistory.filter(m => m.role === "user" || m.role === "assistant"));
    typingItem.remove();

    if(res.ok){
      // å¦‚æœæ˜¯é™çº§æ¨¡å¼è¿”å› replyï¼Œå°±è¡¥ä¸Š
      if(typeof res.reply === "string"){
        chatHistory[chatHistory.length - 1].content = res.reply || "(ç©ºå›å¤)";
        saveChat();
        renderChat();
      }else{
        saveChat();
      }
      return;
    }

    // å¤±è´¥ï¼šæŠŠæœ€åä¸€æ¡ assistant å†™é”™è¯¯
    chatHistory[chatHistory.length - 1].content = `è¯·æ±‚å¤±è´¥ï¼šHTTP ${res.status}${res.detail ? ("ï¼Œ" + res.detail) : ""}`;
    saveChat();
    renderChat();
  }catch(e){
    typingItem.remove();
    chatHistory[chatHistory.length - 1].content = "ç½‘ç»œ/åç«¯é”™è¯¯ï¼šè¯·ç¡®è®¤ Render åç«¯æ­£å¸¸è¿è¡Œ";
    saveChat();
    renderChat();
  }
}

document.getElementById("btnSendChat").addEventListener("click", sendChat);
chatInput.addEventListener("keydown", (e) => {
  if(e.key === "Enter") sendChat();
});

document.getElementById("btnClearChat").addEventListener("click", () => {
  chatHistory = [];
  saveChat();
  renderChat();
  chatHint.textContent = "å·²æ¸…ç©ºå¯¹è¯";
});

/* ---------------- TODO ---------------- */
let todos = JSON.parse(localStorage.getItem("todos")||"[]");
function saveTodos(){ localStorage.setItem("todos", JSON.stringify(todos)); }
function renderTodos(){
  const list = document.getElementById("todoList");
  list.innerHTML = "";
  todos.forEach((t,i)=>{
    const li = document.createElement("li");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!t.done;
    cb.addEventListener("change", ()=>{
      todos[i].done = !todos[i].done;
      saveTodos();
      renderTodos();
    });

    const text = document.createElement("div");
    text.textContent = t.text;

    li.appendChild(cb);
    li.appendChild(text);
    list.appendChild(li);
  });
}
function addTodo(){
  const input = document.getElementById("todoInput");
  const v = input.value.trim();
  if(!v) return;
  todos.push({ text: v, done:false });
  input.value = "";
  saveTodos();
  renderTodos();
}
document.getElementById("btnAddTodo").addEventListener("click", addTodo);
renderTodos();
</script>

</body>
</html>
